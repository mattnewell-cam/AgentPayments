<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LLM Wallet Hub (Devnet)</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 900px; margin: 2rem auto; padding: 0 1rem; }
    input, button, textarea, select { padding: 8px; margin: 4px 0; width: 100%; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
    code { background: #f7f7f7; padding: 2px 6px; border-radius: 6px; }
    .muted { color: #666; font-size: 0.9rem; }
    .balance { font-size: 1.1rem; margin: 8px 0 12px; }
    .balance code { font-size: 1.05rem; }
  </style>
</head>
<body>
  <h1>LLM Wallet Hub (Devnet MVP)</h1>
  <p class="muted">Create wallet, fund from external wallet, issue tool key, paste prompt into GPT/Claude/Gemini.</p>

  <div class="card">
    <h3>Signup / Login</h3>
    <div class="row">
      <div>
        <input id="email" placeholder="email" />
      </div>
      <div>
        <input id="password" type="password" placeholder="password (min 8 chars)" />
      </div>
    </div>
    <div class="row">
      <button onclick="signup()">Signup</button>
      <button onclick="login()">Login</button>
    </div>
    <p>Session: <code id="token">none</code></p>
  </div>

  <div class="card">
    <h3>Wallet</h3>
    <p class="balance">Current balance: <code id="balanceDisplay">unknown</code></p>
    <div class="row">
      <button onclick="loadMe()">Refresh Wallet</button>
      <button onclick="requestFaucetTopup()">Request Faucet Top-up (0.5 SOL)</button>
    </div>
    <pre id="me">not loaded</pre>
    <pre id="faucetResult">faucet result: none</pre>
    <p class="muted">Top-up tries devnet faucet first; if rate-limited, server can optionally fallback to bot wallet transfer.</p>
  </div>

  <div class="card">
    <h3>Create LLM Tool Key</h3>
    <div class="row">
      <input id="keyName" placeholder="Key name" value="gpt-key" />
      <input id="maxSolPerPayment" type="number" step="0.001" value="0.01" />
    </div>
    <div class="row">
      <input id="dailySolCap" type="number" step="0.001" value="0.05" />
      <input id="allowlist" placeholder="Allowlist recipients (comma-separated, optional)" />
    </div>
    <button onclick="createKey()">Create Key</button>
    <pre id="newKey">none</pre>
    <p class="muted">Copy this into your LLM:</p>
    <textarea id="llmInstructions" rows="14" placeholder="Instructions will appear after key creation"></textarea>
    <button onclick="copyLlmInstructions()">Copy LLM Instructions</button>
  </div>

  <div class="card">
    <h3>My Keys</h3>
    <button onclick="loadKeys()">Load Keys</button>
    <div id="keysList"></div>
  </div>

  <div class="card">
    <h3>System Prompt</h3>
    <select id="model">
      <option value="gpt">GPT</option>
      <option value="claude">Claude</option>
      <option value="gemini">Gemini</option>
    </select>
    <button onclick="loadPrompt()">Generate Prompt</button>
    <textarea id="prompt" rows="16"></textarea>
  </div>

<script>
let sessionToken = null;

function headers() {
  return {
    'Content-Type': 'application/json',
    ...(sessionToken ? { 'x-session-token': sessionToken } : {})
  };
}

function updateBalanceDisplay(data) {
  if (typeof data?.balanceSol === 'number') {
    balanceDisplay.textContent = `${data.balanceSol.toFixed(6)} SOL`;
    return;
  }
  if (typeof data?.user?.walletAddress === 'string') {
    balanceDisplay.textContent = '0.000000 SOL';
    return;
  }
  balanceDisplay.textContent = 'unknown';
}

async function signup() {
  const r = await fetch('/api/signup', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email: email.value, password: password.value })
  });
  const data = await r.json();
  if (data.sessionToken) {
    sessionToken = data.sessionToken;
    token.textContent = sessionToken;
  }
  me.textContent = JSON.stringify(data, null, 2);
  updateBalanceDisplay(data);
  if (data.sessionToken) await loadMe();
}

async function login() {
  const r = await fetch('/api/login', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email: email.value, password: password.value })
  });
  const data = await r.json();
  if (data.sessionToken) {
    sessionToken = data.sessionToken;
    token.textContent = sessionToken;
  }
  me.textContent = JSON.stringify(data, null, 2);
  updateBalanceDisplay(data);
  if (data.sessionToken) await loadMe();
}

async function loadMe() {
  const r = await fetch('/api/me', { headers: headers() });
  const data = await r.json();
  me.textContent = JSON.stringify(data, null, 2);
  updateBalanceDisplay(data);
}

async function createKey() {
  const allowlistedRecipients = allowlist.value
    .split(',')
    .map(x => x.trim())
    .filter(Boolean);

  const r = await fetch('/api/keys', {
    method: 'POST', headers: headers(),
    body: JSON.stringify({
      name: keyName.value,
      maxSolPerPayment: Number(maxSolPerPayment.value),
      dailySolCap: Number(dailySolCap.value),
      allowlistedRecipients
    })
  });
  const data = await r.json();
  newKey.textContent = JSON.stringify(data, null, 2);
  llmInstructions.value = data.llmSetupInstructions || '';
}

async function copyLlmInstructions() {
  if (!llmInstructions.value) return;
  await navigator.clipboard.writeText(llmInstructions.value);
}

async function requestFaucetTopup() {
  const r = await fetch('/api/faucet', {
    method: 'POST',
    headers: headers(),
    body: JSON.stringify({ amountSol: 0.5 })
  });
  const data = await r.json();
  faucetResult.textContent = JSON.stringify(data, null, 2);
  if (r.ok) await loadMe();
}

async function loadKeys() {
  const r = await fetch('/api/keys', { headers: headers() });
  const keys = await r.json();
  const container = document.getElementById('keysList');
  if (!Array.isArray(keys) || keys.length === 0) { container.innerHTML = '<p class="muted">No keys found.</p>'; return; }
  container.innerHTML = keys.map(k => `
    <div style="border:1px solid #eee;border-radius:8px;padding:10px;margin:8px 0">
      <strong>${k.name}</strong> <span class="muted">(${k.keyPrefix}...)</span>
      <div class="row" style="margin-top:6px">
        <label>Daily cap: <input type="number" step="0.001" id="cap_${k.id}" value="${k.dailySolCap ?? ''}" /></label>
        <label>Max/payment: <input type="number" step="0.001" id="max_${k.id}" value="${k.maxSolPerPayment ?? ''}" /></label>
      </div>
      <button onclick="updateKey('${k.id}')" style="margin-top:6px">Save</button>
    </div>`).join('');
}

async function updateKey(id) {
  const cap = document.getElementById('cap_' + id).value;
  const max = document.getElementById('max_' + id).value;
  const body = {};
  if (cap !== '') body.dailySolCap = Number(cap);
  if (max !== '') body.maxSolPerPayment = Number(max);
  const r = await fetch('/api/keys/' + id, { method: 'PATCH', headers: headers(), body: JSON.stringify(body) });
  const data = await r.json();
  if (r.ok) { alert('Key updated'); loadKeys(); } else { alert(data.error || 'Update failed'); }
}

async function loadPrompt() {
  const r = await fetch(`/api/system-prompt?model=${encodeURIComponent(model.value)}`, { headers: headers() });
  const data = await r.json();
  prompt.value = data.prompt || JSON.stringify(data, null, 2);
}
</script>
</body>
</html>
